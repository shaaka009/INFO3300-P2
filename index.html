<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>US Tech Market</title>

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Raleway:400,700" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>

    <style>
        p {
            margin: 50px;
        }
    </style>
</head>

<body>
    <h1
        style="font-size: 36px; font-family: 'Lato', sans-serif; font-weight: 700; text-align: center; margin-top: 20px;">
        TODO: P2 Title</h1>
    <h2 style="font-family: 'Lato', sans-serif; font-weight: bold; font-size: 28px; color: #333;">
        Chart 1: NFL Drafts vs Location</h2>
    <p id="chart1"
        style="margin:1in; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <script>
            const svgWidth = 1200;
            const svgHeight = 650;
            const svg = d3.select('#chart1')
                .append('svg')
                .attr('width', svgWidth)
                .attr('height', svgHeight)

            const defaultYear = 2021;
            const chartTitle = svg
                .append("text")
                .attr("x", svgWidth / 2)
                .attr("y", 20)
                .attr("text-anchor", "middle")
                .style("font-size", "24px")
                .style("font-family", "Raleway, sans-serif")
                .text(`${defaultYear} NFL Drafts`)

            const margin = { top: 20, right: 100, bottom: 20, left: 20 };
            const mapWidth = svgWidth - margin.left - margin.right;
            const mapHeight = svgHeight - margin.top - margin.bottom;
            const map = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const requestData = async function () {
                const [nflData, schoolsData, usData, stateIdData, schoolCommonData] = await Promise.all([
                    d3.csv('nfl_draft_prospects.csv'),
                    d3.csv('schools_data.csv'),
                    d3.json('us-smaller.json'),
                    d3.csv('state-id.csv'),
                    d3.csv('school_common_names.csv')
                ])

                // Add slider
                const sliderWidth = 300;
                const sliderHeight = 10;
                const slider = d3.select('#chart1')
                    .append('input')
                    .attr('type', 'range')
                    .attr('min', 1967)
                    .attr('max', 2021)
                    .attr('step', 1)
                    .attr('value', defaultYear)
                    .style('width', `${sliderWidth}px`)
                    .style('height', `${sliderHeight}px`)
                    .style('cursor', 'pointer')
                    .style('background', '#ddd')
                    .style('outline', 'none')
                    .style('border-radius', '5px')
                    .on('input', function () {
                        const selectedYear = this.value;
                        chartTitle.text(`${selectedYear} NFL Drafts`);
                    })
                    .on('pointerup', function () {
                        const selectedYear = this.value;

                        // Update only on off to improve performance
                        updateMapColors(selectedYear);
                    });

                const states = topojson.feature(usData, usData.objects.states);
                const projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
                const path = d3.geoPath().projection(projection);

                // Common name to full university name
                const stateCommonName = {}
                schoolCommonData.forEach(school => {
                    stateCommonName[school['Common Name']] = school['Full University Name']
                    if (school['Common Name 2']) {
                        stateCommonName[school['Common Name 2']] = school['Full University Name']
                    }
                })

                // Pre-process state map --> map from year to state counts map
                const stateMap = new Map()
                nflData.forEach(player => {
                    const draftYear = +player.draft_year;

                    const findSchool = (school) => {
                        const schoolName = school['Name']
                        if (schoolName.includes(player.school)) return true
                        return schoolName.includes(stateCommonName[player.school])
                    }

                    const playerSchool = schoolsData.find(findSchool);
                    const state = playerSchool ? playerSchool['State abbreviation'] : null;

                    if (state) {
                        if (!stateMap.has(draftYear)) stateMap.set(draftYear, {});
                        if (!stateMap.get(draftYear)[state]) stateMap.get(draftYear)[state] = []
                        stateMap.get(draftYear)[state].push(
                            {
                                player,
                                playerSchool
                            }
                        );
                    }
                });

                // State-id to name
                const stateId = {}
                stateIdData.forEach(state => {
                    stateId[state.state_code] = state.state_name;
                })

                const updateMapColors = function (selectedYear) {
                    const year = parseInt(selectedYear)
                    const stateDraftees = stateMap.get(year) || {}
                    const stateCounts = {}
                    Object.entries(stateDraftees).forEach(([key, value]) => {
                        stateCounts[key] = value.length
                    });

                    // Update the color scale based on the counts for the selected year
                    const colorScale = d3.
                        scaleSequential(d3.interpolateViridis)
                        .domain([0, d3.max(Object.values(stateCounts)) || 1]);

                    // Draw and color states
                    const statePaths = map.selectAll("path.state").data(states.features)
                        .join("path")
                        .attr("class", "state")
                        .attr("note", d => d.id)
                        .attr("d", path)
                        .attr("stroke", "#333")
                        .attr("stroke-width", 1)
                        .transition()
                        .duration(500)
                        .ease(d3.easeCubicInOut)
                        .style("fill", (d) => {
                            const stateAbbr = stateId[d.id];
                            const count = stateCounts[stateAbbr] || 0;
                            return colorScale(count);
                        });

                    // Create legend
                    const legendWidth = 30;
                    const legendHeight = 400;

                    // Remove existing legend before updating
                    svg.select(".legend").remove();

                    const g = svg
                        .append('g')
                        .attr('class', 'legend')
                        .attr('transform', `translate(${mapWidth + 30}, 100)`);

                    const defs = svg.append("defs");
                    const gradient = defs.append("linearGradient")
                        .attr("id", "legend-gradient")
                        .attr("x1", "0%")
                        .attr("y1", "100%")
                        .attr("x2", "0%")
                        .attr("y2", "0%");

                    const colorDomain = colorScale.domain();
                    gradient.selectAll("stop")
                        .data(colorDomain)
                        .enter()
                        .append("stop")
                        .attr("offset", (d, i) => `${(i / (colorDomain.length - 1)) * 100}%`)
                        .attr("stop-color", d => colorScale(d));

                    g.append("rect")
                        .attr("width", legendWidth)
                        .attr("height", legendHeight)
                        .style("fill", "url(#legend-gradient)");

                    const legendScale = d3.scaleLinear()
                        .domain([colorDomain[0], colorDomain[colorDomain.length - 1]])
                        .range([legendHeight, 0]);

                    const legendAxis = d3.axisRight(legendScale)
                        .ticks(5)
                        .tickSize(10)
                        .tickFormat(d => d3.format(".0f")(d));

                    g.append("g")
                        .attr("class", "legend-axis")
                        .attr("transform", `translate(${legendWidth}, 0)`)
                        .call(legendAxis)
                        .select(".domain").remove();

                    g.append("text")
                        .attr("class", "legend-title")
                        .attr("x", legendWidth / 2)
                        .attr("y", -10)
                        .attr("text-anchor", "middle")
                        .style("font-size", "12px")
                        .text("Number of NFL Draftees");
                }

                // Default update
                updateMapColors(defaultYear)
            };

            requestData();

            // TODO: Add interactive zoom s.t. users can manually zoom to trigger zoom in and out effect w.r.t. state (or by clicking the state)
        </script>
    </p>

    <h2 style="font-family: 'Lato', sans-serif; font-weight: bold; font-size: 28px; color: #333;">
        Chart 2: TODO</h2>
    <p id="chart2">
        <svg id="chart2" width="1000" height="800"></svg>
        <script>
        </script>
    </p>

    <p style="font-family: 'Raleway', sans-serif;">
    <h4 style="font-family: 'Lato', sans-serif; font-weight: bold; font-size: 28px; color: #333;">
        Sources:</h4>
    <ul>
        <li>Kaggle data set with nfl draft prospects:
            <a
                href="https://www.kaggle.com/datasets/jacklichtenstein/espn-nfl-draft-prospect-data/data?select=nfl_draft_prospects.csv">https://www.kaggle.com/datasets/jacklichtenstein/espn-nfl-draft-prospect-data/data?select=nfl_draft_prospects.csv</a>
        <li>School geographic data: <a href="https://www.kaggle.com/datasets/sumithbhongale/american-university-data-ipeds-dataset
">https://www.kaggle.com/datasets/sumithbhongale/american-university-data-ipeds-dataset
            </a>
        </li>
        <li> D3 Documentation for relevant functions and resources:
            <a href="https://devdocs.io/d3/"> https://devdocs.io/d3/
        </li>

        </li>
    </ul>

    </p>
</body>

</html>